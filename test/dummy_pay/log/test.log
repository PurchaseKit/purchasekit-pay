  [1m[35m (0.2ms)[0m  [1m[35mDROP TABLE IF EXISTS "pay_charges"[0m
  [1m[35m (0.4ms)[0m  [1m[35mCREATE TABLE "pay_charges" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "amount" integer NOT NULL, "amount_refunded" integer, "application_fee_amount" integer, "created_at" datetime(6) NOT NULL, "currency" varchar, "customer_id" bigint NOT NULL, "data" json, "metadata" json, "object" json, "processor_id" varchar NOT NULL, "stripe_account" varchar, "subscription_id" bigint, "type" varchar, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_charges_on_customer_id_and_processor_id" ON "pay_charges" ("customer_id", "processor_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_pay_charges_on_subscription_id" ON "pay_charges" ("subscription_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "pay_customers"[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "pay_customers" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "created_at" datetime(6) NOT NULL, "data" json, "default" boolean, "deleted_at" datetime, "object" json, "owner_id" bigint, "owner_type" varchar, "processor" varchar NOT NULL, "processor_id" varchar, "stripe_account" varchar, "type" varchar, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "pay_customer_owner_index" ON "pay_customers" ("owner_type", "owner_id", "deleted_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_customers_on_processor_and_processor_id" ON "pay_customers" ("processor", "processor_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "pay_merchants"[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "pay_merchants" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "created_at" datetime(6) NOT NULL, "data" json, "default" boolean, "owner_id" bigint, "owner_type" varchar, "processor" varchar NOT NULL, "processor_id" varchar, "type" varchar, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_pay_merchants_on_owner_type_and_owner_id_and_processor" ON "pay_merchants" ("owner_type", "owner_id", "processor")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "pay_payment_methods"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "pay_payment_methods" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "created_at" datetime(6) NOT NULL, "customer_id" bigint NOT NULL, "data" json, "default" boolean, "payment_method_type" varchar, "processor_id" varchar NOT NULL, "stripe_account" varchar, "type" varchar, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_payment_methods_on_customer_id_and_processor_id" ON "pay_payment_methods" ("customer_id", "processor_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "pay_subscriptions"[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "pay_subscriptions" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "application_fee_percent" decimal(8,2), "created_at" datetime(6) NOT NULL, "current_period_end" datetime, "current_period_start" datetime, "customer_id" bigint NOT NULL, "data" json, "ends_at" datetime, "metadata" json, "metered" boolean, "name" varchar NOT NULL, "object" json, "pause_behavior" varchar, "pause_resumes_at" datetime, "pause_starts_at" datetime, "payment_method_id" varchar, "processor_id" varchar NOT NULL, "processor_plan" varchar NOT NULL, "quantity" integer DEFAULT 1 NOT NULL, "status" varchar NOT NULL, "stripe_account" varchar, "trial_ends_at" datetime, "type" varchar, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_subscriptions_on_customer_id_and_processor_id" ON "pay_subscriptions" ("customer_id", "processor_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_pay_subscriptions_on_metered" ON "pay_subscriptions" ("metered")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_pay_subscriptions_on_pause_starts_at" ON "pay_subscriptions" ("pause_starts_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "pay_webhooks"[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "pay_webhooks" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "created_at" datetime(6) NOT NULL, "event" json, "event_type" varchar, "processor" varchar, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TEMPORARY TABLE "apay_charges" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "amount" integer NOT NULL, "amount_refunded" integer, "application_fee_amount" integer, "created_at" datetime(6) NOT NULL, "currency" varchar, "customer_id" bigint NOT NULL, "data" json, "metadata" json, "object" json, "processor_id" varchar NOT NULL, "stripe_account" varchar, "subscription_id" bigint, "type" varchar, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "tindex_apay_charges_on_subscription_id" ON "apay_charges" ("subscription_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "tindex_apay_charges_on_customer_id_and_processor_id" ON "apay_charges" ("customer_id", "processor_id")[0m
  [1m[35mSQL (0.0ms)[0m  [1m[32mINSERT INTO "apay_charges" ("id","amount","amount_refunded","application_fee_amount","created_at","currency","customer_id","data","metadata","object","processor_id","stripe_account","subscription_id","type","updated_at")
                     SELECT "id","amount","amount_refunded","application_fee_amount","created_at","currency","customer_id","data","metadata","object","processor_id","stripe_account","subscription_id","type","updated_at" FROM "pay_charges"[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE "pay_charges"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "pay_charges" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "amount" integer NOT NULL, "amount_refunded" integer, "application_fee_amount" integer, "created_at" datetime(6) NOT NULL, "currency" varchar, "customer_id" bigint NOT NULL, "data" json, "metadata" json, "object" json, "processor_id" varchar NOT NULL, "stripe_account" varchar, "subscription_id" bigint, "type" varchar, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_b19d32f835"
FOREIGN KEY ("customer_id")
  REFERENCES "pay_customers" ("id")
)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_charges_on_customer_id_and_processor_id" ON "pay_charges" ("customer_id", "processor_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_pay_charges_on_subscription_id" ON "pay_charges" ("subscription_id")[0m
  [1m[35mSQL (0.0ms)[0m  [1m[32mINSERT INTO "pay_charges" ("id","amount","amount_refunded","application_fee_amount","created_at","currency","customer_id","data","metadata","object","processor_id","stripe_account","subscription_id","type","updated_at")
                     SELECT "id","amount","amount_refunded","application_fee_amount","created_at","currency","customer_id","data","metadata","object","processor_id","stripe_account","subscription_id","type","updated_at" FROM "apay_charges"[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE "apay_charges"[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TEMPORARY TABLE "apay_charges" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "amount" integer NOT NULL, "amount_refunded" integer, "application_fee_amount" integer, "created_at" datetime(6) NOT NULL, "currency" varchar, "customer_id" bigint NOT NULL, "data" json, "metadata" json, "object" json, "processor_id" varchar NOT NULL, "stripe_account" varchar, "subscription_id" bigint, "type" varchar, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "tindex_apay_charges_on_subscription_id" ON "apay_charges" ("subscription_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "tindex_apay_charges_on_customer_id_and_processor_id" ON "apay_charges" ("customer_id", "processor_id")[0m
  [1m[35mSQL (0.0ms)[0m  [1m[32mINSERT INTO "apay_charges" ("id","amount","amount_refunded","application_fee_amount","created_at","currency","customer_id","data","metadata","object","processor_id","stripe_account","subscription_id","type","updated_at")
                     SELECT "id","amount","amount_refunded","application_fee_amount","created_at","currency","customer_id","data","metadata","object","processor_id","stripe_account","subscription_id","type","updated_at" FROM "pay_charges"[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE "pay_charges"[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "pay_charges" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "amount" integer NOT NULL, "amount_refunded" integer, "application_fee_amount" integer, "created_at" datetime(6) NOT NULL, "currency" varchar, "customer_id" bigint NOT NULL, "data" json, "metadata" json, "object" json, "processor_id" varchar NOT NULL, "stripe_account" varchar, "subscription_id" bigint, "type" varchar, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_b19d32f835"
FOREIGN KEY ("customer_id")
  REFERENCES "pay_customers" ("id")
, CONSTRAINT "fk_rails_44a2c276fa"
FOREIGN KEY ("subscription_id")
  REFERENCES "pay_subscriptions" ("id")
)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_charges_on_customer_id_and_processor_id" ON "pay_charges" ("customer_id", "processor_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_pay_charges_on_subscription_id" ON "pay_charges" ("subscription_id")[0m
  [1m[35mSQL (0.0ms)[0m  [1m[32mINSERT INTO "pay_charges" ("id","amount","amount_refunded","application_fee_amount","created_at","currency","customer_id","data","metadata","object","processor_id","stripe_account","subscription_id","type","updated_at")
                     SELECT "id","amount","amount_refunded","application_fee_amount","created_at","currency","customer_id","data","metadata","object","processor_id","stripe_account","subscription_id","type","updated_at" FROM "apay_charges"[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE "apay_charges"[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TEMPORARY TABLE "apay_payment_methods" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "created_at" datetime(6) NOT NULL, "customer_id" bigint NOT NULL, "data" json, "default" boolean, "payment_method_type" varchar, "processor_id" varchar NOT NULL, "stripe_account" varchar, "type" varchar, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "tindex_apay_payment_methods_on_customer_id_and_processor_id" ON "apay_payment_methods" ("customer_id", "processor_id")[0m
  [1m[35mSQL (0.0ms)[0m  [1m[32mINSERT INTO "apay_payment_methods" ("id","created_at","customer_id","data","default","payment_method_type","processor_id","stripe_account","type","updated_at")
                     SELECT "id","created_at","customer_id","data","default","payment_method_type","processor_id","stripe_account","type","updated_at" FROM "pay_payment_methods"[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE "pay_payment_methods"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "pay_payment_methods" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "created_at" datetime(6) NOT NULL, "customer_id" bigint NOT NULL, "data" json, "default" boolean, "payment_method_type" varchar, "processor_id" varchar NOT NULL, "stripe_account" varchar, "type" varchar, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_c78c6cb84d"
FOREIGN KEY ("customer_id")
  REFERENCES "pay_customers" ("id")
)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_payment_methods_on_customer_id_and_processor_id" ON "pay_payment_methods" ("customer_id", "processor_id")[0m
  [1m[35mSQL (0.0ms)[0m  [1m[32mINSERT INTO "pay_payment_methods" ("id","created_at","customer_id","data","default","payment_method_type","processor_id","stripe_account","type","updated_at")
                     SELECT "id","created_at","customer_id","data","default","payment_method_type","processor_id","stripe_account","type","updated_at" FROM "apay_payment_methods"[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE "apay_payment_methods"[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TEMPORARY TABLE "apay_subscriptions" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "application_fee_percent" decimal(8,2), "created_at" datetime(6) NOT NULL, "current_period_end" datetime, "current_period_start" datetime, "customer_id" bigint NOT NULL, "data" json, "ends_at" datetime, "metadata" json, "metered" boolean, "name" varchar NOT NULL, "object" json, "pause_behavior" varchar, "pause_resumes_at" datetime, "pause_starts_at" datetime, "payment_method_id" varchar, "processor_id" varchar NOT NULL, "processor_plan" varchar NOT NULL, "quantity" integer DEFAULT 1 NOT NULL, "status" varchar NOT NULL, "stripe_account" varchar, "trial_ends_at" datetime, "type" varchar, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "tindex_apay_subscriptions_on_pause_starts_at" ON "apay_subscriptions" ("pause_starts_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "tindex_apay_subscriptions_on_metered" ON "apay_subscriptions" ("metered")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "tindex_apay_subscriptions_on_customer_id_and_processor_id" ON "apay_subscriptions" ("customer_id", "processor_id")[0m
  [1m[35mSQL (0.0ms)[0m  [1m[32mINSERT INTO "apay_subscriptions" ("id","application_fee_percent","created_at","current_period_end","current_period_start","customer_id","data","ends_at","metadata","metered","name","object","pause_behavior","pause_resumes_at","pause_starts_at","payment_method_id","processor_id","processor_plan","quantity","status","stripe_account","trial_ends_at","type","updated_at")
                     SELECT "id","application_fee_percent","created_at","current_period_end","current_period_start","customer_id","data","ends_at","metadata","metered","name","object","pause_behavior","pause_resumes_at","pause_starts_at","payment_method_id","processor_id","processor_plan","quantity","status","stripe_account","trial_ends_at","type","updated_at" FROM "pay_subscriptions"[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE "pay_subscriptions"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "pay_subscriptions" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "application_fee_percent" decimal(8,2), "created_at" datetime(6) NOT NULL, "current_period_end" datetime, "current_period_start" datetime, "customer_id" bigint NOT NULL, "data" json, "ends_at" datetime, "metadata" json, "metered" boolean, "name" varchar NOT NULL, "object" json, "pause_behavior" varchar, "pause_resumes_at" datetime, "pause_starts_at" datetime, "payment_method_id" varchar, "processor_id" varchar NOT NULL, "processor_plan" varchar NOT NULL, "quantity" integer DEFAULT 1 NOT NULL, "status" varchar NOT NULL, "stripe_account" varchar, "trial_ends_at" datetime, "type" varchar, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_b7cd64d378"
FOREIGN KEY ("customer_id")
  REFERENCES "pay_customers" ("id")
)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_subscriptions_on_customer_id_and_processor_id" ON "pay_subscriptions" ("customer_id", "processor_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_pay_subscriptions_on_metered" ON "pay_subscriptions" ("metered")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_pay_subscriptions_on_pause_starts_at" ON "pay_subscriptions" ("pause_starts_at")[0m
  [1m[35mSQL (0.0ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("id","application_fee_percent","created_at","current_period_end","current_period_start","customer_id","data","ends_at","metadata","metered","name","object","pause_behavior","pause_resumes_at","pause_starts_at","payment_method_id","processor_id","processor_plan","quantity","status","stripe_account","trial_ends_at","type","updated_at")
                     SELECT "id","application_fee_percent","created_at","current_period_end","current_period_start","customer_id","data","ends_at","metadata","metered","name","object","pause_behavior","pause_resumes_at","pause_starts_at","payment_method_id","processor_id","processor_plan","quantity","status","stripe_account","trial_ends_at","type","updated_at" FROM "apay_subscriptions"[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE "apay_subscriptions"[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (0.0ms)[0m  [1m[32mINSERT INTO "schema_migrations" (version) VALUES (20251223021914)[0m
  [1m[35m (0.0ms)[0m  [1m[32mINSERT INTO "schema_migrations" (version) VALUES
(20251223021913),
(20251223021912);[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.0ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.0ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2026-01-11 23:50:17.737467', '2026-01-11 23:50:17.737468') RETURNING "key"[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.0ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Load (0.0ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.0ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('schema_sha1', 'a22ed0ff65ce30a751b9c19abad054fa6fe3c70c', '2026-01-11 23:50:17.737800', '2026-01-11 23:50:17.737800') RETURNING "key"[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.2ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2026-01-11 23:57:06.453525', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, 'Pay::Purchasekit::Customer', '2026-01-11 23:57:06.453525')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_handles_subscription_required_error
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-11 15:57:06 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
rescue_from handled PurchaseKit::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent/remote.rb:26:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_error.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 24ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 7.1ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
---------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-11 15:57:06 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_intent.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.1ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
----------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-11 15:57:06 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
Completed 500 Internal Server Error in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_subscriptions";
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2026-01-11 23:57:06.538266', '2026-02-11 23:57:06', '2025-12-11 23:57:06', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, 'Pay::Purchasekit::Subscription', '2026-01-11 23:57:06.538266')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.3ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.5ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.5ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2026-01-11 23:57:06.545816"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.6ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-02-11 23:57:06"], ["status", "canceled"], ["updated_at", "2026-01-11 23:57:06.554702"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_missing_signature
-------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-11 15:57:06 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:57:06Z", "current_period_end"=>"2027-01-11T23:57:06Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:57:06Z", "current_period_end"=>"2027-01-11T23:57:06Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_ignores_unregistered_event_types
--------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-11 15:57:06 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank_in_development
------------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-11 15:57:06 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:57:06Z", "current_period_end"=>"2027-01-11T23:57:06Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:57:06Z", "current_period_end"=>"2027-01-11T23:57:06Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-11 23:57:06.568135"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-11T23:57:06Z\",\"current_period_end\":\"2027-01-11T23:57:06Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-11 23:57:06.568135"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 80747760-fb3e-4193-803d-b5c6afe8683e) to Test(default) with arguments: 1
Completed 200 OK in 4ms (ActiveRecord: 0.3ms (1 query, 0 cached) | GC: 0.2ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_invalid_signature
-------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-11 15:57:06 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:57:06Z", "current_period_end"=>"2027-01-11T23:57:06Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:57:06Z", "current_period_end"=>"2027-01-11T23:57:06Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
----------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-11 15:57:06 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:57:06Z", "current_period_end"=>"2027-01-11T23:57:06Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:57:06Z", "current_period_end"=>"2027-01-11T23:57:06Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-11 23:57:06.571807"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-11T23:57:06Z\",\"current_period_end\":\"2027-01-11T23:57:06Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-11 23:57:06.571807"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: c52b3ea4-6337-40bf-80e0-980251353757) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_request_when_secret_blank_in_production
-----------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-11 15:57:06 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:57:06Z", "current_period_end"=>"2027-01-11T23:57:06Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:57:06Z", "current_period_end"=>"2027-01-11T23:57:06Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: webhook_secret must be configured
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_accepts_valid_signature
-----------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-11 15:57:06 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:57:06Z", "current_period_end"=>"2027-01-11T23:57:06Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:57:06Z", "current_period_end"=>"2027-01-11T23:57:06Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-11 23:57:06.574336"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-11T23:57:06Z\",\"current_period_end\":\"2027-01-11T23:57:06Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-11 23:57:06.574336"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: faeceeed-c6ea-4d83-a927-06940fc47569) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_plan_option_not_selected_by_default
------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_plan_option_renders_radio_and_label
------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
----------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
--------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
-------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_renders_span_with_data_attributes
----------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_with_custom_loading_content
----------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_raises_outside_plan_option_block
---------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer_id
-----------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_creates_webhook_record_and_enqueues_job
---------------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-11 23:57:06.586102"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-11 23:57:06.586102"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 691dc905-d099-4552-a6ec-1167774bb8cd) to Test(default) with arguments: 1
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_skips_unregistered_event_types
------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_broadcasts_redirect_when_success_path_present
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-11 23:57:06"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-11 23:57:06.589288"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_does_not_broadcast_when_success_path_missing
------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-11 23:57:06"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-11 23:57:06.591488"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.0ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-03-11 23:57:06"], ["current_period_start", "2026-01-11 23:57:06"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-11 23:57:06.592726"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-11 23:57:06.602110"], ["current_period_end", "2027-01-11 23:57:06"], ["current_period_start", "2026-01-11 23:57:06"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-11 23:57:06.602110"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_subscription_methods_raise_appropriate_errors
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_sti_test"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_sti_test"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-11 23:57:06.608116"], ["current_period_end", "2027-01-11 23:57:06"], ["current_period_start", "2026-01-11 23:57:06"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_sti_test"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-11 23:57:06.608116"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_sti_test"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.0ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-11 23:57:06.609660"], ["current_period_end", "2027-01-11 23:57:06"], ["current_period_start", "2026-01-11 23:57:06"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-11 23:57:06.609660"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-11 23:57:06"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-11 23:57:06.611358"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.2ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2026-01-11 23:58:36.043524', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, 'Pay::Purchasekit::Customer', '2026-01-11 23:58:36.043524');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2026-01-11 23:58:36.045043', '2026-02-11 23:58:36', '2025-12-11 23:58:36', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, 'Pay::Purchasekit::Subscription', '2026-01-11 23:58:36.045043')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-11 23:58:36"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-11 23:58:36.069230"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-11 23:58:36.078940"], ["current_period_end", "2027-01-11 23:58:36"], ["current_period_start", "2026-01-11 23:58:36"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-11 23:58:36.078940"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-11 23:58:36.084614"], ["current_period_end", "2027-01-11 23:58:36"], ["current_period_start", "2026-01-11 23:58:36"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-11 23:58:36.084614"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_subscription_methods_raise_appropriate_errors
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_sti_test"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_sti_test"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-11 23:58:36.086318"], ["current_period_end", "2027-01-11 23:58:36"], ["current_period_start", "2026-01-11 23:58:36"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_sti_test"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-11 23:58:36.086318"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_sti_test"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_skips_unregistered_event_types
------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_creates_webhook_record_and_enqueues_job
---------------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-11 23:58:36.132558"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-11 23:58:36.132558"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 91072a4d-022a-415a-bc68-c56de7bfb018) to Test(default) with arguments: 1
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-03-11 23:58:36"], ["current_period_start", "2026-01-11 23:58:36"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-11 23:58:36.135747"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_does_not_broadcast_when_success_path_missing
------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-11 23:58:36"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-11 23:58:36.137360"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_broadcasts_redirect_when_success_path_present
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-11 23:58:36"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-11 23:58:36.138596"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2026-01-11 23:58:36.140490"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_handles_subscription_required_error
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-11 15:58:36 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
rescue_from handled PurchaseKit::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent/remote.rb:26:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_error.html.erb (Duration: 0.2ms | GC: 0.0ms)
Completed 200 OK in 7ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_handles_not_found_product
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-11 15:58:36 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_MISSING", "success_path"=>"/dashboard", "environment"=>"sandbox"}
rescue_from handled PurchaseKit::NotFoundError (App or product not found) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent/remote.rb:28:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_error.html.erb (Duration: 0.0ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
---------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-11 15:58:36 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_intent.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-02-11 23:58:36"], ["status", "canceled"], ["updated_at", "2026-01-11 23:58:36.172825"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_missing_signature
-------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-11 15:58:36 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:58:36Z", "current_period_end"=>"2027-01-11T23:58:36Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:58:36Z", "current_period_end"=>"2027-01-11T23:58:36Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_request_when_secret_blank_in_production
-----------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-11 15:58:36 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:58:36Z", "current_period_end"=>"2027-01-11T23:58:36Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:58:36Z", "current_period_end"=>"2027-01-11T23:58:36Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: webhook_secret must be configured
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_invalid_signature
-------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-11 15:58:36 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:58:36Z", "current_period_end"=>"2027-01-11T23:58:36Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:58:36Z", "current_period_end"=>"2027-01-11T23:58:36Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_ignores_unregistered_event_types
--------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-11 15:58:36 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_accepts_valid_signature
-----------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-11 15:58:36 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:58:36Z", "current_period_end"=>"2027-01-11T23:58:36Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:58:36Z", "current_period_end"=>"2027-01-11T23:58:36Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-11 23:58:36.180756"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-11T23:58:36Z\",\"current_period_end\":\"2027-01-11T23:58:36Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-11 23:58:36.180756"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 6129ec0b-be3d-472e-bc41-0b1f5a50fbc3) to Test(default) with arguments: 1
Completed 200 OK in 1ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank_in_development
------------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-11 15:58:36 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:58:36Z", "current_period_end"=>"2027-01-11T23:58:36Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:58:36Z", "current_period_end"=>"2027-01-11T23:58:36Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-11 23:58:36.182286"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-11T23:58:36Z\",\"current_period_end\":\"2027-01-11T23:58:36Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-11 23:58:36.182286"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 4d899e88-6306-47b8-b35b-c823ba133da9) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
----------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-11 15:58:36 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:58:36Z", "current_period_end"=>"2027-01-11T23:58:36Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-11T23:58:36Z", "current_period_end"=>"2027-01-11T23:58:36Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-11 23:58:36.183546"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-11T23:58:36Z\",\"current_period_end\":\"2027-01-11T23:58:36Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-11 23:58:36.183546"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 0e625d07-8692-4de7-bbe6-f6b3c4182b9e) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_raises_outside_plan_option_block
---------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_with_custom_loading_content
----------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
--------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_plan_option_not_selected_by_default
------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
-------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer_id
-----------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
----------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_renders_span_with_data_attributes
----------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_plan_option_renders_radio_and_label
------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.3ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.6ms)[0m  [1m[31mDELETE FROM "pay_customers";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2026-01-12 12:36:56.819661', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, 'Pay::Purchasekit::Customer', '2026-01-12 12:36:56.819661')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_request_when_secret_blank_in_production
-----------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:36:56 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:36:56Z", "current_period_end"=>"2027-01-12T12:36:56Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:36:56Z", "current_period_end"=>"2027-01-12T12:36:56Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: webhook_secret must be configured
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_ignores_unregistered_event_types
--------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:36:56 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_accepts_valid_signature
-----------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:36:56 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:36:56Z", "current_period_end"=>"2027-01-12T12:36:56Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:36:56Z", "current_period_end"=>"2027-01-12T12:36:56Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:36:56.863379"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-12T12:36:56Z\",\"current_period_end\":\"2027-01-12T12:36:56Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:36:56.863379"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: fb0b1262-9f16-4f26-a693-64bdf539a056) to Test(default) with arguments: 1
Completed 200 OK in 7ms (ActiveRecord: 0.3ms (1 query, 0 cached) | GC: 3.7ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
----------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:36:56 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:36:56Z", "current_period_end"=>"2027-01-12T12:36:56Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:36:56Z", "current_period_end"=>"2027-01-12T12:36:56Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:36:56.866229"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-12T12:36:56Z\",\"current_period_end\":\"2027-01-12T12:36:56Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:36:56.866229"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 55b7ee0a-0ff5-48e5-8658-af93e28c9881) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank_in_development
------------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:36:56 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:36:56Z", "current_period_end"=>"2027-01-12T12:36:56Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:36:56Z", "current_period_end"=>"2027-01-12T12:36:56Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:36:56.867880"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-12T12:36:56Z\",\"current_period_end\":\"2027-01-12T12:36:56Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:36:56.867880"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 27735bda-bbf4-4719-a567-fab008f2e07d) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_invalid_signature
-------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:36:56 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:36:56Z", "current_period_end"=>"2027-01-12T12:36:56Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:36:56Z", "current_period_end"=>"2027-01-12T12:36:56Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_missing_signature
-------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:36:56 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:36:56Z", "current_period_end"=>"2027-01-12T12:36:56Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:36:56Z", "current_period_end"=>"2027-01-12T12:36:56Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_subscriptions";
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2026-01-12 12:36:56.902812', '2026-02-12 12:36:56', '2025-12-12 12:36:56', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, 'Pay::Purchasekit::Subscription', '2026-01-12 12:36:56.902812')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2026-01-12 12:36:56.912678"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
---------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-12 04:36:56 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_intent.html.erb (Duration: 0.2ms | GC: 0.0ms)
Completed 200 OK in 8ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_handles_not_found_product
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-12 04:36:56 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_MISSING", "success_path"=>"/dashboard", "environment"=>"sandbox"}
rescue_from handled PurchaseKit::NotFoundError (App or product not found) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent/remote.rb:28:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_error.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_handles_subscription_required_error
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-12 04:36:56 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
rescue_from handled PurchaseKit::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent/remote.rb:26:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_error.html.erb (Duration: 0.0ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_creates_webhook_record_and_enqueues_job
---------------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:36:56.931326"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:36:56.931326"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: b4d163c5-4e56-4e52-acdb-4937b4efb345) to Test(default) with arguments: 1
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_skips_unregistered_event_types
------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_with_custom_loading_content
----------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
--------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_plan_option_not_selected_by_default
------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_renders_span_with_data_attributes
----------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer_id
-----------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
----------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_plan_option_renders_radio_and_label
------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_raises_outside_plan_option_block
---------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
-------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-02-12 12:36:56"], ["status", "canceled"], ["updated_at", "2026-01-12 12:36:56.947183"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-03-12 12:36:56"], ["current_period_start", "2026-01-12 12:36:56"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:36:56.948804"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_broadcasts_redirect_when_success_path_present
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-12 12:36:56"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:36:56.951706"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_does_not_broadcast_when_success_path_missing
------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-12 12:36:56"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:36:56.953183"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-12 12:36:56"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:36:56.954816"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_subscription_methods_raise_appropriate_errors
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_sti_test"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_sti_test"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-12 12:36:56.959017"], ["current_period_end", "2027-01-12 12:36:56"], ["current_period_start", "2026-01-12 12:36:56"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_sti_test"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-12 12:36:56.959017"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_sti_test"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.0ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.0ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-12 12:36:56.960607"], ["current_period_end", "2027-01-12 12:36:56"], ["current_period_start", "2026-01-12 12:36:56"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-12 12:36:56.960607"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-12 12:36:56.965728"], ["current_period_end", "2027-01-12 12:36:56"], ["current_period_start", "2026-01-12 12:36:56"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-12 12:36:56.965728"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2026-01-12 12:39:54.313211', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, 'Pay::Purchasekit::Customer', '2026-01-12 12:39:54.313211')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_request_when_secret_blank_in_production
-----------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:39:54 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:39:54Z", "current_period_end"=>"2027-01-12T12:39:54Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:39:54Z", "current_period_end"=>"2027-01-12T12:39:54Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: webhook_secret must be configured
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
----------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:39:54 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:39:54Z", "current_period_end"=>"2027-01-12T12:39:54Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:39:54Z", "current_period_end"=>"2027-01-12T12:39:54Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:39:54.357336"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-12T12:39:54Z\",\"current_period_end\":\"2027-01-12T12:39:54Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:39:54.357336"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 0d80c767-cae1-46d0-ac67-afa09b651a08) to Test(default) with arguments: 1
Completed 200 OK in 4ms (ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.2ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank_in_development
------------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:39:54 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:39:54Z", "current_period_end"=>"2027-01-12T12:39:54Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:39:54Z", "current_period_end"=>"2027-01-12T12:39:54Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:39:54.360297"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-12T12:39:54Z\",\"current_period_end\":\"2027-01-12T12:39:54Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:39:54.360297"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 25cf4914-bead-4e5c-ab02-84b5db2db5a2) to Test(default) with arguments: 1
Completed 200 OK in 1ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_invalid_signature
-------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:39:54 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:39:54Z", "current_period_end"=>"2027-01-12T12:39:54Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:39:54Z", "current_period_end"=>"2027-01-12T12:39:54Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_accepts_valid_signature
-----------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:39:54 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:39:54Z", "current_period_end"=>"2027-01-12T12:39:54Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:39:54Z", "current_period_end"=>"2027-01-12T12:39:54Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:39:54.363314"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-12T12:39:54Z\",\"current_period_end\":\"2027-01-12T12:39:54Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:39:54.363314"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: fab26f13-ddc3-4c3d-aa57-cebeba8b1f80) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_ignores_unregistered_event_types
--------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:39:54 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_missing_signature
-------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:39:54 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:39:54Z", "current_period_end"=>"2027-01-12T12:39:54Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:39:54Z", "current_period_end"=>"2027-01-12T12:39:54Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_creates_webhook_record_and_enqueues_job
---------------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:39:54.366647"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:39:54.366647"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: de905c18-78bd-46a1-b426-7b4104a0c6dd) to Test(default) with arguments: 1
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_skips_unregistered_event_types
------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer_id
-----------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_plan_option_renders_radio_and_label
------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_plan_option_not_selected_by_default
------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_raises_outside_plan_option_block
---------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
-------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_with_custom_loading_content
----------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_renders_span_with_data_attributes
----------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
--------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
----------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_subscriptions";
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2026-01-12 12:39:54.409343', '2026-02-12 12:39:54', '2025-12-12 12:39:54', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, 'Pay::Purchasekit::Subscription', '2026-01-12 12:39:54.409343')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2026-01-12 12:39:54.419687"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_broadcasts_redirect_when_success_path_present
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-12 12:39:54"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:39:54.430447"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-03-12 12:39:54"], ["current_period_start", "2026-01-12 12:39:54"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:39:54.432561"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_does_not_broadcast_when_success_path_missing
------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-12 12:39:54"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:39:54.434098"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_handles_not_found_product
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-12 04:39:54 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_MISSING", "success_path"=>"/dashboard", "environment"=>"sandbox"}
rescue_from handled PurchaseKit::NotFoundError (App or product not found) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent/remote.rb:28:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_error.html.erb (Duration: 0.2ms | GC: 0.0ms)
Completed 200 OK in 7ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
---------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-12 04:39:54 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_intent.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_handles_subscription_required_error
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-12 04:39:54 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
rescue_from handled PurchaseKit::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent/remote.rb:26:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_error.html.erb (Duration: 0.0ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-02-12 12:39:54"], ["status", "canceled"], ["updated_at", "2026-01-12 12:39:54.450903"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-12 12:39:54.455396"], ["current_period_end", "2027-01-12 12:39:54"], ["current_period_start", "2026-01-12 12:39:54"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-12 12:39:54.455396"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_subscription_methods_raise_appropriate_errors
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_sti_test"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_sti_test"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-12 12:39:54.460778"], ["current_period_end", "2027-01-12 12:39:54"], ["current_period_start", "2026-01-12 12:39:54"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_sti_test"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-12 12:39:54.460778"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_sti_test"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-12 12:39:54"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:39:54.462485"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.0ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-12 12:39:54.463951"], ["current_period_end", "2027-01-12 12:39:54"], ["current_period_start", "2026-01-12 12:39:54"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-12 12:39:54.463951"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.3ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.2ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.8ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2026-01-12 12:42:32.742253', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, 'Pay::Purchasekit::Customer', '2026-01-12 12:42:32.742253');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2026-01-12 12:42:32.743940', '2026-02-12 12:42:32', '2025-12-12 12:42:32', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, 'Pay::Purchasekit::Subscription', '2026-01-12 12:42:32.743940')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-12 12:42:32"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:42:32.776474"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.3ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-12 12:42:32.783152"], ["current_period_end", "2027-01-12 12:42:32"], ["current_period_start", "2026-01-12 12:42:32"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-12 12:42:32.783152"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_subscription_methods_raise_appropriate_errors
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_sti_test"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_sti_test"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-12 12:42:32.789481"], ["current_period_end", "2027-01-12 12:42:32"], ["current_period_start", "2026-01-12 12:42:32"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_sti_test"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-12 12:42:32.789481"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_sti_test"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-12 12:42:32.791475"], ["current_period_end", "2027-01-12 12:42:32"], ["current_period_start", "2026-01-12 12:42:32"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-12 12:42:32.791475"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
---------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-12 04:42:32 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_intent.html.erb (Duration: 0.2ms | GC: 0.0ms)
Completed 200 OK in 43ms (Views: 0.1ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 22.9ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_handles_not_found_product
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-12 04:42:32 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_MISSING", "success_path"=>"/dashboard", "environment"=>"sandbox"}
rescue_from handled PurchaseKit::NotFoundError (App or product not found) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent/remote.rb:28:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_error.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 2ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_handles_subscription_required_error
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-12 04:42:32 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
rescue_from handled PurchaseKit::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent/remote.rb:26:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_error.html.erb (Duration: 0.0ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-03-12 12:42:32"], ["current_period_start", "2026-01-12 12:42:32"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:42:32.867067"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_broadcasts_redirect_when_success_path_present
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-12 12:42:32"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:42:32.868911"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_does_not_broadcast_when_success_path_missing
------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-12 12:42:32"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:42:32.871264"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-02-12 12:42:32"], ["status", "canceled"], ["updated_at", "2026-01-12 12:42:32.874049"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_raises_outside_plan_option_block
---------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_plan_option_renders_radio_and_label
------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
--------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer_id
-----------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_renders_span_with_data_attributes
----------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_with_custom_loading_content
----------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_plan_option_not_selected_by_default
------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
-------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
----------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_request_when_secret_blank_in_production
-----------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:42:32 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:42:32Z", "current_period_end"=>"2027-01-12T12:42:32Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:42:32Z", "current_period_end"=>"2027-01-12T12:42:32Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: webhook_secret must be configured
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
----------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:42:32 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:42:32Z", "current_period_end"=>"2027-01-12T12:42:32Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:42:32Z", "current_period_end"=>"2027-01-12T12:42:32Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:42:32.888648"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-12T12:42:32Z\",\"current_period_end\":\"2027-01-12T12:42:32Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:42:32.888648"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 4f7d580a-ad3d-4afd-88fd-9bfceb7b2f6e) to Test(default) with arguments: 1
Completed 200 OK in 4ms (ActiveRecord: 0.3ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_ignores_unregistered_event_types
--------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:42:32 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_missing_signature
-------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:42:32 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:42:32Z", "current_period_end"=>"2027-01-12T12:42:32Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:42:32Z", "current_period_end"=>"2027-01-12T12:42:32Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_invalid_signature
-------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:42:32 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:42:32Z", "current_period_end"=>"2027-01-12T12:42:32Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:42:32Z", "current_period_end"=>"2027-01-12T12:42:32Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank_in_development
------------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:42:32 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:42:32Z", "current_period_end"=>"2027-01-12T12:42:32Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:42:32Z", "current_period_end"=>"2027-01-12T12:42:32Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:42:32.895720"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-12T12:42:32Z\",\"current_period_end\":\"2027-01-12T12:42:32Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:42:32.895720"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 631338d1-c906-4316-9c1e-565c8c181732) to Test(default) with arguments: 1
Completed 200 OK in 1ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_accepts_valid_signature
-----------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:42:32 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:42:32Z", "current_period_end"=>"2027-01-12T12:42:32Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:42:32Z", "current_period_end"=>"2027-01-12T12:42:32Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:42:32.897521"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-12T12:42:32Z\",\"current_period_end\":\"2027-01-12T12:42:32Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:42:32.897521"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 5a145fd2-69a2-460f-baa6-d176704445d3) to Test(default) with arguments: 1
Completed 200 OK in 1ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_creates_webhook_record_and_enqueues_job
---------------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:42:32.898907"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:42:32.898907"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: e26d3d81-4aeb-498e-8a7b-39cad319e9fe) to Test(default) with arguments: 1
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_skips_unregistered_event_types
------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2026-01-12 12:42:32.917733"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.3ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.2ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.9ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2026-01-12 12:43:52.194092', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, 'Pay::Purchasekit::Customer', '2026-01-12 12:43:52.194092');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2026-01-12 12:43:52.195419', '2026-02-12 12:43:52', '2025-12-12 12:43:52', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, 'Pay::Purchasekit::Subscription', '2026-01-12 12:43:52.195419')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-12 12:43:52.241343"], ["current_period_end", "2027-01-12 12:43:52"], ["current_period_start", "2026-01-12 12:43:52"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-12 12:43:52.241343"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_subscription_methods_raise_appropriate_errors
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_sti_test"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_sti_test"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-12 12:43:52.248258"], ["current_period_end", "2027-01-12 12:43:52"], ["current_period_start", "2026-01-12 12:43:52"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_sti_test"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-12 12:43:52.248258"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_sti_test"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-12 12:43:52"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:43:52.250128"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-12 12:43:52.251749"], ["current_period_end", "2027-01-12 12:43:52"], ["current_period_start", "2026-01-12 12:43:52"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-12 12:43:52.251749"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
----------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:43:52 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:43:52Z", "current_period_end"=>"2027-01-12T12:43:52Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:43:52Z", "current_period_end"=>"2027-01-12T12:43:52Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:43:52.270585"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-12T12:43:52Z\",\"current_period_end\":\"2027-01-12T12:43:52Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:43:52.270585"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: c28d1fab-ef4b-44c0-982a-ff4c2ef34415) to Test(default) with arguments: 1
Completed 200 OK in 3ms (ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_request_when_secret_blank_in_production
-----------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:43:52 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:43:52Z", "current_period_end"=>"2027-01-12T12:43:52Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:43:52Z", "current_period_end"=>"2027-01-12T12:43:52Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: webhook_secret must be configured
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank_in_development
------------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:43:52 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:43:52Z", "current_period_end"=>"2027-01-12T12:43:52Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:43:52Z", "current_period_end"=>"2027-01-12T12:43:52Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:43:52.278113"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-12T12:43:52Z\",\"current_period_end\":\"2027-01-12T12:43:52Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:43:52.278113"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 7ecdce86-705d-4bda-a3db-f020680f31d6) to Test(default) with arguments: 1
Completed 200 OK in 1ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_invalid_signature
-------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:43:52 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:43:52Z", "current_period_end"=>"2027-01-12T12:43:52Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:43:52Z", "current_period_end"=>"2027-01-12T12:43:52Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_ignores_unregistered_event_types
--------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:43:52 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_accepts_valid_signature
-----------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:43:52 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:43:52Z", "current_period_end"=>"2027-01-12T12:43:52Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:43:52Z", "current_period_end"=>"2027-01-12T12:43:52Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:43:52.281885"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-12T12:43:52Z\",\"current_period_end\":\"2027-01-12T12:43:52Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:43:52.281885"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: c853f7e9-fa2d-45f9-b418-f6dad30137a0) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_missing_signature
-------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:43:52 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:43:52Z", "current_period_end"=>"2027-01-12T12:43:52Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:43:52Z", "current_period_end"=>"2027-01-12T12:43:52Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_handles_not_found_product
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-12 04:43:52 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_MISSING", "success_path"=>"/dashboard", "environment"=>"sandbox"}
rescue_from handled PurchaseKit::NotFoundError (App or product not found) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent/remote.rb:28:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_error.html.erb (Duration: 0.2ms | GC: 0.0ms)
Completed 200 OK in 8ms (Views: 0.1ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
---------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-12 04:43:52 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_intent.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_handles_subscription_required_error
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-12 04:43:52 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
rescue_from handled PurchaseKit::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent/remote.rb:26:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_error.html.erb (Duration: 0.0ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_broadcasts_redirect_when_success_path_present
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-12 12:43:52"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:43:52.312023"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-03-12 12:43:52"], ["current_period_start", "2026-01-12 12:43:52"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:43:52.314368"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_does_not_broadcast_when_success_path_missing
------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-12 12:43:52"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:43:52.315971"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_with_custom_loading_content
----------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
----------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
-------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_raises_outside_plan_option_block
---------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_plan_option_not_selected_by_default
------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer_id
-----------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_renders_span_with_data_attributes
----------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_plan_option_renders_radio_and_label
------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
--------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_creates_webhook_record_and_enqueues_job
---------------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:43:52.322090"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:43:52.322090"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: b0da5c05-8d20-4059-8d60-246813ad3608) to Test(default) with arguments: 1
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_skips_unregistered_event_types
------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2026-01-12 12:43:52.325205"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-02-12 12:43:52"], ["status", "canceled"], ["updated_at", "2026-01-12 12:43:52.327420"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.2ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.7ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2026-01-12 12:54:22.790039', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, 'Pay::Purchasekit::Customer', '2026-01-12 12:54:22.790039');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2026-01-12 12:54:22.791476', '2026-02-12 12:54:22', '2025-12-12 12:54:22', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, 'Pay::Purchasekit::Subscription', '2026-01-12 12:54:22.791476')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-03-12 12:54:22"], ["current_period_start", "2026-01-12 12:54:22"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:54:22.810793"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_broadcasts_redirect_when_success_path_present
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-12 12:54:22"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:54:22.821266"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_does_not_broadcast_when_success_path_missing
------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-12 12:54:22"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:54:22.823082"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-02-12 12:54:22"], ["status", "canceled"], ["updated_at", "2026-01-12 12:54:22.857230"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_skips_unregistered_event_types
------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_creates_webhook_record_and_enqueues_job
---------------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:54:22.869020"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:54:22.869020"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 15c1fd60-d584-4458-8f9d-1a09ad6be0c0) to Test(default) with arguments: 1
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2026-01-12 12:54:22.871919"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_renders_span_with_data_attributes
----------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_plan_option_renders_radio_and_label
------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
-------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
----------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
--------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_plan_option_not_selected_by_default
------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer_id
-----------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_with_custom_loading_content
----------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_raises_outside_plan_option_block
---------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_request_when_secret_blank_in_production
-----------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:54:22 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:22Z", "current_period_end"=>"2027-01-12T12:54:22Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:22Z", "current_period_end"=>"2027-01-12T12:54:22Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: webhook_secret must be configured
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_missing_signature
-------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:54:22 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:22Z", "current_period_end"=>"2027-01-12T12:54:22Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:22Z", "current_period_end"=>"2027-01-12T12:54:22Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank_in_development
------------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:54:22 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:22Z", "current_period_end"=>"2027-01-12T12:54:22Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:22Z", "current_period_end"=>"2027-01-12T12:54:22Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:54:22.899766"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-12T12:54:22Z\",\"current_period_end\":\"2027-01-12T12:54:22Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:54:22.899766"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: b0e69de8-3904-432c-ab1d-6ecd87bbd8a0) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_ignores_unregistered_event_types
--------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:54:22 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_invalid_signature
-------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:54:22 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:22Z", "current_period_end"=>"2027-01-12T12:54:22Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:22Z", "current_period_end"=>"2027-01-12T12:54:22Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_accepts_valid_signature
-----------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:54:22 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:22Z", "current_period_end"=>"2027-01-12T12:54:22Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:22Z", "current_period_end"=>"2027-01-12T12:54:22Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:54:22.903388"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-12T12:54:22Z\",\"current_period_end\":\"2027-01-12T12:54:22Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:54:22.903388"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 3afbc108-0ffa-4055-b0f3-d2716bcb66bc) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
----------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:54:22 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:22Z", "current_period_end"=>"2027-01-12T12:54:22Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:22Z", "current_period_end"=>"2027-01-12T12:54:22Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:54:22.904823"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-12T12:54:22Z\",\"current_period_end\":\"2027-01-12T12:54:22Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:54:22.904823"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: d5645b50-ac54-4224-95fb-7626a99e132a) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_handles_not_found_product
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-12 04:54:22 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_MISSING", "success_path"=>"/dashboard", "environment"=>"sandbox"}
rescue_from handled PurchaseKit::NotFoundError (App or product not found) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent/remote.rb:28:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_error.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 7ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_handles_subscription_required_error
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-12 04:54:22 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
rescue_from handled PurchaseKit::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent/remote.rb:26:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_error.html.erb (Duration: 0.0ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
---------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-12 04:54:22 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_intent.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-12 12:54:22"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:54:22.921567"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-12 12:54:22.925640"], ["current_period_end", "2027-01-12 12:54:22"], ["current_period_start", "2026-01-12 12:54:22"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-12 12:54:22.925640"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-12 12:54:22.931039"], ["current_period_end", "2027-01-12 12:54:22"], ["current_period_start", "2026-01-12 12:54:22"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-12 12:54:22.931039"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_subscription_methods_raise_appropriate_errors
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_sti_test"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_sti_test"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.0ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-12 12:54:22.932652"], ["current_period_end", "2027-01-12 12:54:22"], ["current_period_start", "2026-01-12 12:54:22"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_sti_test"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-12 12:54:22.932652"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_sti_test"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_plan_option_not_selected_by_default
------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_renders_span_with_data_attributes
----------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer_id
-----------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
----------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_with_custom_loading_content
----------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_plan_option_renders_radio_and_label
------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
-------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
--------------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::PaywallHelperTest: test_price_raises_outside_plan_option_block
---------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2026-01-12 12:54:28.749535', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, 'Pay::Purchasekit::Customer', '2026-01-12 12:54:28.749535')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_handles_subscription_required_error
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-12 04:54:28 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
rescue_from handled PurchaseKit::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent/remote.rb:26:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_error.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 30ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 17.5ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
---------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-12 04:54:28 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_intent.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::PurchasesControllerTest: test_create_handles_not_found_product
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2026-01-12 04:54:28 -0800
Processing by PurchaseKit::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_MISSING", "success_path"=>"/dashboard", "environment"=>"sandbox"}
rescue_from handled PurchaseKit::NotFoundError (App or product not found) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent/remote.rb:28:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/purchases/_error.html.erb (Duration: 0.0ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.0ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.0ms)[0m  [1m[31mDELETE FROM "pay_subscriptions";
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2026-01-12 12:54:28.809127', '2026-02-12 12:54:28', '2025-12-12 12:54:28', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, 'Pay::Purchasekit::Subscription', '2026-01-12 12:54:28.809127')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2026-01-12 12:54:28.818045"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_skips_unregistered_event_types
------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_creates_webhook_record_and_enqueues_job
---------------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:54:28.822276"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:54:28.822276"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: d72b7b39-a9af-4f65-836b-260148d9efa2) to Test(default) with arguments: 1
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-02-12 12:54:28"], ["status", "canceled"], ["updated_at", "2026-01-12 12:54:28.830650"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank_in_development
------------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:54:28 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:28Z", "current_period_end"=>"2027-01-12T12:54:28Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:28Z", "current_period_end"=>"2027-01-12T12:54:28Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:54:28.835384"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-12T12:54:28Z\",\"current_period_end\":\"2027-01-12T12:54:28Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:54:28.835384"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 2d6587d8-3bbe-4d12-a4eb-d5c5e5715720) to Test(default) with arguments: 1
Completed 200 OK in 1ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_ignores_unregistered_event_types
--------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:54:28 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_missing_signature
-------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:54:28 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:28Z", "current_period_end"=>"2027-01-12T12:54:28Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:28Z", "current_period_end"=>"2027-01-12T12:54:28Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_accepts_valid_signature
-----------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:54:28 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:28Z", "current_period_end"=>"2027-01-12T12:54:28Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:28Z", "current_period_end"=>"2027-01-12T12:54:28Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:54:28.839673"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-12T12:54:28Z\",\"current_period_end\":\"2027-01-12T12:54:28Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:54:28.839673"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 9f7bab76-1275-4b63-ab14-c8797a2a5352) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
----------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:54:28 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:28Z", "current_period_end"=>"2027-01-12T12:54:28Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:28Z", "current_period_end"=>"2027-01-12T12:54:28Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2026-01-12 12:54:28.840921"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2026-01-12T12:54:28Z\",\"current_period_end\":\"2027-01-12T12:54:28Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2026-01-12 12:54:28.840921"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 2d749792-19c2-4b41-82b3-46416627e4db) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_request_when_secret_blank_in_production
-----------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:54:28 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:28Z", "current_period_end"=>"2027-01-12T12:54:28Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:28Z", "current_period_end"=>"2027-01-12T12:54:28Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: webhook_secret must be configured
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------
PurchaseKit::WebhooksControllerTest: test_rejects_invalid_signature
-------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2026-01-12 04:54:28 -0800
Processing by PurchaseKit::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:28Z", "current_period_end"=>"2027-01-12T12:54:28Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2026-01-12T12:54:28Z", "current_period_end"=>"2027-01-12T12:54:28Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_does_not_broadcast_when_success_path_missing
------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-12 12:54:28"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:54:28.847708"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-03-12 12:54:28"], ["current_period_start", "2026-01-12 12:54:28"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:54:28.849592"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_broadcasts_redirect_when_success_path_present
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-12 12:54:28"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:54:28.851036"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-12 12:54:28.855939"], ["current_period_end", "2027-01-12 12:54:28"], ["current_period_start", "2026-01-12 12:54:28"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-12 12:54:28.855939"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_subscription_methods_raise_appropriate_errors
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_sti_test"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_sti_test"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-12 12:54:28.860244"], ["current_period_end", "2027-01-12 12:54:28"], ["current_period_start", "2026-01-12 12:54:28"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_sti_test"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-12 12:54:28.860244"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_sti_test"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2026-01-12 12:54:28"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2026-01-12 12:54:28.862073"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2026-01-12 12:54:28.863604"], ["current_period_end", "2027-01-12 12:54:28"], ["current_period_start", "2026-01-12 12:54:28"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2026-01-12 12:54:28.863604"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
