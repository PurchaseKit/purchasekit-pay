#!/usr/bin/env bash
set -euo pipefail

DRY_RUN=false
if [[ "${1:-}" == "--dry-run" ]]; then
  DRY_RUN=true
  shift
fi

VERSION=${1:-}

if [[ -z "$VERSION" ]]; then
  echo "Usage: bin/release [--dry-run] VERSION"
  echo "Example: bin/release 0.2.0"
  exit 1
fi

if [[ -n $(git status --porcelain) ]]; then
  echo "Error: Working directory not clean. Commit or stash changes first."
  exit 1
fi

VERSION_FILE="lib/purchasekit/pay/version.rb"
CURRENT_VERSION=$(grep -o 'VERSION = "[^"]*"' "$VERSION_FILE" | cut -d'"' -f2)

if [[ "$CURRENT_VERSION" == "$VERSION" ]]; then
  echo "Error: Version is already $VERSION"
  exit 1
fi

if [[ "$DRY_RUN" == true ]]; then
  echo "gem/: $CURRENT_VERSION -> $VERSION"
  exit 0
fi

sed -i '' "s/VERSION = \".*\"/VERSION = \"$VERSION\"/" "$VERSION_FILE"

# Commit version bump
git add "$VERSION_FILE"
git commit -m "Bump version to $VERSION"

# 3. Tag with version
git tag "$VERSION"

# 4. Push to git + tags
git push origin main
git push origin "$VERSION"

# 5. Build gem
gem build purchasekit-pay.gemspec

# 6. Release gem
gem push "purchasekit-pay-$VERSION.gem"

# Cleanup
rm "purchasekit-pay-$VERSION.gem"

echo "Released purchasekit-pay v$VERSION"
